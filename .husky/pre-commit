#!/usr/bin/env sh
. "$(dirname -- "$0")/_/husky.sh"

# ══════════════════════════════════════════════════════════════════════════════
# TezBarakat 前端 pre-commit 检查
# ══════════════════════════════════════════════════════════════════════════════
# 本 Hook 在每次 git commit 前自动运行，拦截以下问题：
#   1. ESLint 代码规范检查（lint-staged）
#   2. i18n 翻译文件自动同步（src/i18n/locales/ → public/locales/）
#   3. i18n 翻译文件一致性检查（i18n-validate）
# ══════════════════════════════════════════════════════════════════════════════

# ── 步骤 1：ESLint + Prettier（仅检查暂存区文件）──────────────────────────
echo ""
echo "🔍 [1/3] 运行 ESLint + Prettier 检查..."
npx lint-staged
LINT_EXIT=$?

if [ $LINT_EXIT -ne 0 ]; then
  echo ""
  echo "❌ ESLint/Prettier 检查失败，提交已中止。"
  echo "   请修复以上代码规范问题后重新提交。"
  echo ""
  exit 1
fi

# ── 步骤 2：i18n 翻译文件自动同步 ────────────────────────────────────────
# 当 src/i18n/locales/ 下的文件被修改时，自动同步到 public/locales/
# 并将同步后的文件加入暂存区，确保提交包含两套一致的文件
LOCALE_FILES_CHANGED=$(git diff --cached --name-only | grep -E "src/i18n/locales/.*\.json$" | wc -l)

if [ "$LOCALE_FILES_CHANGED" -gt 0 ]; then
  echo ""
  echo "🔄 [2/3] 自动同步 i18n 翻译文件..."
  node scripts/i18n-sync.mjs
  SYNC_EXIT=$?

  if [ $SYNC_EXIT -ne 0 ]; then
    echo ""
    echo "❌ i18n 同步失败，提交已中止。"
    echo ""
    exit 1
  fi

  # 将同步后的 public/locales/ 文件加入暂存区
  git add public/locales/*.json 2>/dev/null
  echo "   已将 public/locales/ 加入暂存区"
else
  echo ""
  echo "⏭  [2/3] 无翻译文件变更，跳过 i18n 同步"
fi

# ── 步骤 3：i18n 翻译文件一致性检查 ──────────────────────────────────────
# 仅当翻译文件被修改时才运行检查（优化性能）
TS_FILES_CHANGED=$(git diff --cached --name-only | grep -E "\.(ts|tsx)$" | wc -l)

if [ "$LOCALE_FILES_CHANGED" -gt 0 ] || [ "$TS_FILES_CHANGED" -gt 0 ]; then
  echo ""
  echo "🌐 [3/3] 运行 i18n 翻译文件一致性检查..."
  node scripts/i18n-validate.mjs
  I18N_EXIT=$?

  if [ $I18N_EXIT -ne 0 ]; then
    echo ""
    echo "❌ i18n 检查失败，提交已中止。"
    echo "   请确保 ru.json、tg.json、zh.json 三个文件的键完全一致。"
    echo "   运行 'pnpm i18n:validate' 查看详细报告。"
    echo ""
    exit 1
  fi
else
  echo ""
  echo "⏭  [3/3] 无翻译文件或 TS 文件变更，跳过 i18n 检查"
fi

echo ""
echo "✅ 所有检查通过，提交继续..."
echo ""
exit 0
