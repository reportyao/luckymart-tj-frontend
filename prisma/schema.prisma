// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

// Looking for ways to speed up your queries, or scale easily with your serverless or edge functions?
// Try Prisma Accelerate: https://pris.ly/cli/accelerate-init

generator client {
  provider = "prisma-client"
  output   = "../generated/prisma"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ==========================================
// 1. 用户认证和管理模块
// ==========================================

// 用户主表
model User {
  id                String    @id @default(cuid())
  telegramId        String    @unique @map("telegram_id")
  telegramUsername  String?   @map("telegram_username")
  firstName         String?   @map("first_name")
  lastName          String?   @map("last_name")
  avatarUrl         String?   @map("avatar_url")
  languageCode      String    @default("zh") @map("language_code") // zh, ru, tg
  phoneNumber       String?   @map("phone_number")
  email             String?   @unique
  
  // 状态字段
  status            UserStatus @default(ACTIVE)
  isVerified        Boolean    @default(false) @map("is_verified")
  kycLevel          KycLevel   @default(NONE) @map("kyc_level")
  
  // 安全设置
  twoFactorEnabled  Boolean    @default(false) @map("two_factor_enabled")
  lastLoginAt       DateTime?  @map("last_login_at")
  lastActiveAt      DateTime?  @map("last_active_at")
  
  // 推广相关
  referralCode      String     @unique @map("referral_code")
  referredById      String?    @map("referred_by_id")
  referredBy        User?      @relation("UserReferrals", fields: [referredById], references: [id])
  referrals         User[]     @relation("UserReferrals")
  
  // 统计数据
  totalSpent        Decimal    @default(0) @map("total_spent") @db.Decimal(10,2)
  totalWon          Decimal    @default(0) @map("total_won") @db.Decimal(10,2)
  totalLotteries    Int        @default(0) @map("total_lotteries")
  winningRate       Decimal    @default(0) @map("winning_rate") @db.Decimal(5,4)
  
  // 元数据
  createdAt         DateTime   @default(now()) @map("created_at")
  updatedAt         DateTime   @updatedAt @map("updated_at")
  deletedAt         DateTime?  @map("deleted_at")

  // 关联关系
  wallets           Wallet[]
  orders            Order[]
  lotteryEntries    LotteryEntry[]
  notifications     Notification[]
  posts             Post[]
  comments          Comment[]
  likes             Like[]
  marketListings    MarketListing[]
  marketPurchases   MarketPurchase[]
  commissions       Commission[]
  userSessions      UserSession[]
  
  @@map("users")
  @@index([telegramId])
  @@index([referralCode])
  @@index([status])
  @@index([createdAt])
}

// 用户会话表
model UserSession {
  id           String    @id @default(cuid())
  userId       String    @map("user_id")
  sessionToken String    @unique @map("session_token")
  device       String?
  ipAddress    String?   @map("ip_address")
  userAgent    String?   @map("user_agent")
  location     String?
  isActive     Boolean   @default(true) @map("is_active")
  expiresAt    DateTime  @map("expires_at")
  createdAt    DateTime  @default(now()) @map("created_at")
  
  user         User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  @@map("user_sessions")
  @@index([userId])
  @@index([sessionToken])
  @@index([expiresAt])
}

// 用户状态枚举
enum UserStatus {
  ACTIVE
  SUSPENDED
  BANNED
  PENDING_VERIFICATION
}

// KYC等级枚举
enum KycLevel {
  NONE
  BASIC
  INTERMEDIATE
  ADVANCED
}

// ==========================================
// 2. 双币钱包系统
// ==========================================

// 钱包主表
model Wallet {
  id                String      @id @default(cuid())
  userId            String      @map("user_id")
  type              WalletType
  currency          Currency
  balance           Decimal     @default(0) @db.Decimal(10,2)
  frozenBalance     Decimal     @default(0) @map("frozen_balance") @db.Decimal(10,2)
  totalDeposits     Decimal     @default(0) @map("total_deposits") @db.Decimal(10,2)
  totalWithdrawals  Decimal     @default(0) @map("total_withdrawals") @db.Decimal(10,2)
  
  // 版本控制用于并发安全
  version           Int         @default(1)
  
  // 元数据
  createdAt         DateTime    @default(now()) @map("created_at")
  updatedAt         DateTime    @updatedAt @map("updated_at")
  
  user              User        @relation(fields: [userId], references: [id], onDelete: Cascade)
  transactions      WalletTransaction[]
  
  @@map("wallets")
  @@unique([userId, type, currency])
  @@index([userId])
  @@index([type])
}

// 钱包交易记录表
model WalletTransaction {
  id                String            @id @default(cuid())
  walletId          String            @map("wallet_id")
  type              TransactionType
  amount            Decimal           @db.Decimal(10,2)
  balanceBefore     Decimal           @map("balance_before") @db.Decimal(10,2)
  balanceAfter      Decimal           @map("balance_after") @db.Decimal(10,2)
  status            TransactionStatus @default(PENDING)
  description       String?
  
  // 关联信息
  relatedOrderId    String?           @map("related_order_id")
  relatedLotteryId  String?           @map("related_lottery_id")
  referenceId       String?           @map("reference_id") // 外部交易ID
  
  // 元数据
  processedAt       DateTime?         @map("processed_at")
  createdAt         DateTime          @default(now()) @map("created_at")
  
  wallet            Wallet            @relation(fields: [walletId], references: [id], onDelete: Cascade)
  
  @@map("wallet_transactions")
  @@index([walletId])
  @@index([type])
  @@index([status])
  @@index([createdAt])
}

// 钱包类型枚举
enum WalletType {
  BALANCE    // 余额钱包
  LUCKY_COIN // 幸运币钱包
}

// 货币类型枚举
enum Currency {
  USD
  TJS // 塔吉克斯坦索莫尼
}

// 交易类型枚举
enum TransactionType {
  DEPOSIT           // 充值
  WITHDRAWAL        // 提现
  LOTTERY_PURCHASE  // 购买彩票
  LOTTERY_REFUND    // 彩票退款
  LOTTERY_PRIZE     // 中奖奖金
  REFERRAL_BONUS    // 推荐奖励
  COIN_EXCHANGE     // 余额与幸运币兑换
  MARKET_PURCHASE   // 市场购买
  MARKET_SALE       // 市场出售
  ADMIN_ADJUSTMENT  // 管理员调整
}

// 交易状态枚举
enum TransactionStatus {
  PENDING
  PROCESSING
  COMPLETED
  FAILED
  CANCELLED
}

// ==========================================
// 3. VRF彩票核心系统
// ==========================================

// 彩票期次表
model Lottery {
  id                String        @id @default(cuid())
  period            String        @unique // 期次号
  title             String        // 彩票标题
  description       String?       // 彩票描述
  imageUrl          String?       @map("image_url")
  
  // 配置参数
  ticketPrice       Decimal       @map("ticket_price") @db.Decimal(10,2)
  totalTickets      Int           @map("total_tickets")
  maxPerUser        Int           @map("max_per_user")
  currency          Currency      @default(USD)
  
  // 状态管理
  status            LotteryStatus @default(UPCOMING)
  soldTickets       Int           @default(0) @map("sold_tickets")
  winningNumbers    Json?         @map("winning_numbers") // VRF生成的中奖号码
  vrfSeed           String?       @map("vrf_seed")
  vrfProof          String?       @map("vrf_proof")
  
  // 时间管理
  startTime         DateTime      @map("start_time")
  endTime           DateTime      @map("end_time")
  drawTime          DateTime      @map("draw_time")
  actualDrawTime    DateTime?     @map("actual_draw_time")
  
  // 元数据
  createdAt         DateTime      @default(now()) @map("created_at")
  updatedAt         DateTime      @updatedAt @map("updated_at")
  
  // 关联关系
  entries           LotteryEntry[]
  orders            Order[]
  marketListings    MarketListing[]
  
  @@map("lotteries")
  @@index([period])
  @@index([status])
  @@index([startTime])
  @@index([endTime])
}

// 彩票参与记录表
model LotteryEntry {
  id           String      @id @default(cuid())
  userId       String      @map("user_id")
  lotteryId    String      @map("lottery_id")
  orderId      String      @map("order_id")
  
  // 号码信息
  numbers      Json        // 用户选择的号码
  isWinning    Boolean     @default(false) @map("is_winning")
  prizeAmount  Decimal?    @map("prize_amount") @db.Decimal(10,2)
  prizeRank    Int?        @map("prize_rank")
  
  // 状态管理
  status       EntryStatus @default(ACTIVE)
  
  // 交易相关
  isFromMarket Boolean     @default(false) @map("is_from_market")
  originalOwner String?    @map("original_owner")
  
  // 元数据
  createdAt    DateTime    @default(now()) @map("created_at")
  updatedAt    DateTime    @updatedAt @map("updated_at")
  
  user         User        @relation(fields: [userId], references: [id], onDelete: Cascade)
  lottery      Lottery     @relation(fields: [lotteryId], references: [id], onDelete: Cascade)
  order        Order       @relation(fields: [orderId], references: [id])
  
  @@map("lottery_entries")
  @@unique([lotteryId, numbers]) // 同期彩票号码唯一性
  @@index([userId])
  @@index([lotteryId])
  @@index([isWinning])
  @@index([status])
}

// 彩票状态枚举
enum LotteryStatus {
  UPCOMING    // 即将开始
  ACTIVE      // 进行中
  SOLD_OUT    // 已售完
  DRAWING     // 开奖中
  COMPLETED   // 已完成
  CANCELLED   // 已取消
}

// 参与状态枚举
enum EntryStatus {
  ACTIVE      // 有效
  TRANSFERRED // 已转让
  REFUNDED    // 已退款
}

// ==========================================
// 4. 三级推广系统
// ==========================================

// 推广佣金记录表
model Commission {
  id              String          @id @default(cuid())
  userId          String          @map("user_id") // 获得佣金的用户
  fromUserId      String          @map("from_user_id") // 产生佣金的用户
  level           Int             // 推广层级 (1, 2, 3)
  type            CommissionType
  
  // 佣金信息
  amount          Decimal         @db.Decimal(10,2)
  rate            Decimal         @db.Decimal(5,4) // 佣金比例
  sourceAmount    Decimal         @map("source_amount") @db.Decimal(10,2) // 原始金额
  
  // 关联信息
  relatedOrderId  String?         @map("related_order_id")
  relatedLotteryId String?        @map("related_lottery_id")
  
  // 状态管理
  status          CommissionStatus @default(PENDING)
  paidAt          DateTime?       @map("paid_at")
  
  // 元数据
  createdAt       DateTime        @default(now()) @map("created_at")
  updatedAt       DateTime        @updatedAt @map("updated_at")
  
  user            User            @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  @@map("commissions")
  @@index([userId])
  @@index([fromUserId])
  @@index([level])
  @@index([type])
  @@index([status])
}

// 佣金类型枚举
enum CommissionType {
  LOTTERY_PURCHASE  // 彩票购买佣金
  MARKET_SALE       // 市场交易佣金
  FIRST_PURCHASE    // 首购奖励
}

// 佣金状态枚举
enum CommissionStatus {
  PENDING
  PAID
  CANCELLED
}

// ==========================================
// 5. 订单管理系统
// ==========================================

// 订单主表
model Order {
  id                String        @id @default(cuid())
  userId            String        @map("user_id")
  orderNumber       String        @unique @map("order_number")
  type              OrderType
  
  // 订单信息
  totalAmount       Decimal       @map("total_amount") @db.Decimal(10,2)
  currency          Currency      @default(USD)
  paymentMethod     PaymentMethod @map("payment_method")
  
  // 彩票相关
  lotteryId         String?       @map("lottery_id")
  quantity          Int?          // 购买数量
  selectedNumbers   Json?         @map("selected_numbers") // 选择的号码组合
  
  // 状态管理
  status            OrderStatus   @default(PENDING)
  
  // 支付信息
  paymentId         String?       @map("payment_id")
  paymentData       Json?         @map("payment_data")
  paidAt            DateTime?     @map("paid_at")
  
  // 元数据
  createdAt         DateTime      @default(now()) @map("created_at")
  updatedAt         DateTime      @updatedAt @map("updated_at")
  expiredAt         DateTime?     @map("expired_at")
  
  user              User          @relation(fields: [userId], references: [id], onDelete: Cascade)
  lottery           Lottery?      @relation(fields: [lotteryId], references: [id])
  entries           LotteryEntry[]
  
  @@map("orders")
  @@index([userId])
  @@index([orderNumber])
  @@index([status])
  @@index([createdAt])
  @@index([lotteryId])
}

// 订单类型枚举
enum OrderType {
  LOTTERY_PURCHASE  // 彩票购买
  MARKET_PURCHASE   // 市场购买
  WALLET_RECHARGE   // 钱包充值
}

// 支付方式枚举
enum PaymentMethod {
  BALANCE_WALLET    // 余额钱包
  LUCKY_COIN_WALLET // 幸运币钱包
  EXTERNAL_PAYMENT  // 外部支付
}

// 订单状态枚举
enum OrderStatus {
  PENDING           // 待支付
  PAID              // 已支付
  PROCESSING        // 处理中
  COMPLETED         // 已完成
  CANCELLED         // 已取消
  REFUNDED          // 已退款
  FAILED            // 失败
}

// ==========================================
// 6. 二手市场交易
// ==========================================

// 市场挂单表
model MarketListing {
  id              String             @id @default(cuid())
  sellerId        String             @map("seller_id")
  lotteryId       String             @map("lottery_id")
  entryId         String             @unique @map("entry_id") // 对应的彩票记录
  
  // 价格信息
  originalPrice   Decimal            @map("original_price") @db.Decimal(10,2)
  listingPrice    Decimal            @map("listing_price") @db.Decimal(10,2)
  finalPrice      Decimal?           @map("final_price") @db.Decimal(10,2)
  
  // 状态管理
  status          MarketListingStatus @default(ACTIVE)
  
  // 描述信息
  description     String?
  
  // 元数据
  listedAt        DateTime           @default(now()) @map("listed_at")
  soldAt          DateTime?          @map("sold_at")
  updatedAt       DateTime           @updatedAt @map("updated_at")
  
  seller          User               @relation(fields: [sellerId], references: [id], onDelete: Cascade)
  lottery         Lottery            @relation(fields: [lotteryId], references: [id])
  purchases       MarketPurchase[]
  
  @@map("market_listings")
  @@index([sellerId])
  @@index([lotteryId])
  @@index([status])
  @@index([listingPrice])
  @@index([listedAt])
}

// 市场购买记录表
model MarketPurchase {
  id           String        @id @default(cuid())
  buyerId      String        @map("buyer_id")
  listingId    String        @map("listing_id")
  
  // 交易信息
  purchasePrice Decimal      @map("purchase_price") @db.Decimal(10,2)
  
  // 状态管理
  status       PurchaseStatus @default(PENDING)
  
  // 元数据
  purchasedAt  DateTime      @default(now()) @map("purchased_at")
  completedAt  DateTime?     @map("completed_at")
  
  buyer        User          @relation(fields: [buyerId], references: [id], onDelete: Cascade)
  listing      MarketListing @relation(fields: [listingId], references: [id])
  
  @@map("market_purchases")
  @@index([buyerId])
  @@index([listingId])
  @@index([status])
  @@index([purchasedAt])
}

// 市场挂单状态枚举
enum MarketListingStatus {
  ACTIVE      // 在售中
  SOLD        // 已售出
  CANCELLED   // 已取消
  EXPIRED     // 已过期
}

// 购买状态枚举
enum PurchaseStatus {
  PENDING     // 待处理
  COMPLETED   // 已完成
  CANCELLED   // 已取消
  FAILED      // 失败
}

// ==========================================
// 7. 通知系统
// ==========================================

// 通知表
model Notification {
  id            String           @id @default(cuid())
  userId        String           @map("user_id")
  type          NotificationType
  title         String
  content       String
  
  // 关联信息
  relatedId     String?          @map("related_id") // 关联的业务ID
  relatedType   String?          @map("related_type") // 关联的业务类型
  
  // 状态管理
  isRead        Boolean          @default(false) @map("is_read")
  readAt        DateTime?        @map("read_at")
  
  // 推送相关
  pushChannels  Json?            @map("push_channels") // 推送渠道配置
  pushStatus    Json?            @map("push_status")   // 各渠道推送状态
  
  // 元数据
  createdAt     DateTime         @default(now()) @map("created_at")
  updatedAt     DateTime         @updatedAt @map("updated_at")
  expiredAt     DateTime?        @map("expired_at")
  
  user          User             @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  @@map("notifications")
  @@index([userId])
  @@index([type])
  @@index([isRead])
  @@index([createdAt])
}

// 通知类型枚举
enum NotificationType {
  LOTTERY_RESULT      // 开奖结果
  LOTTERY_REMINDER    // 彩票提醒
  PAYMENT_SUCCESS     // 支付成功
  PAYMENT_FAILED      // 支付失败
  MARKET_SOLD         // 市场售出
  MARKET_PURCHASED    // 市场购买
  REFERRAL_REWARD     // 推荐奖励
  SYSTEM_ANNOUNCEMENT // 系统公告
  ACCOUNT_SECURITY    // 账户安全
}

// ==========================================
// 8. 社交帖子系统
// ==========================================

// 帖子表
model Post {
  id           String     @id @default(cuid())
  userId       String     @map("user_id")
  type         PostType
  title        String?    // 可选标题
  content      String     // 帖子内容
  images       Json?      // 图片URLs数组
  
  // 关联信息
  relatedLotteryId String? @map("related_lottery_id") // 关联的彩票
  relatedOrderId   String? @map("related_order_id")   // 关联的订单
  
  // 统计数据
  likesCount    Int       @default(0) @map("likes_count")
  commentsCount Int       @default(0) @map("comments_count")
  viewsCount    Int       @default(0) @map("views_count")
  
  // 状态管理
  status       PostStatus @default(PUBLISHED)
  
  // 元数据
  publishedAt  DateTime?  @map("published_at")
  createdAt    DateTime   @default(now()) @map("created_at")
  updatedAt    DateTime   @updatedAt @map("updated_at")
  
  user         User       @relation(fields: [userId], references: [id], onDelete: Cascade)
  comments     Comment[]
  likes        Like[]
  
  @@map("posts")
  @@index([userId])
  @@index([type])
  @@index([status])
  @@index([publishedAt])
}

// 评论表
model Comment {
  id        String      @id @default(cuid())
  postId    String      @map("post_id")
  userId    String      @map("user_id")
  content   String
  parentId  String?     @map("parent_id") // 父评论ID，支持回复
  
  // 状态管理
  status    CommentStatus @default(PUBLISHED)
  
  // 元数据
  createdAt DateTime    @default(now()) @map("created_at")
  updatedAt DateTime    @updatedAt @map("updated_at")
  
  post      Post        @relation(fields: [postId], references: [id], onDelete: Cascade)
  user      User        @relation(fields: [userId], references: [id], onDelete: Cascade)
  parent    Comment?    @relation("CommentReplies", fields: [parentId], references: [id])
  replies   Comment[]   @relation("CommentReplies")
  
  @@map("comments")
  @@index([postId])
  @@index([userId])
  @@index([parentId])
  @@index([status])
}

// 点赞表
model Like {
  id        String   @id @default(cuid())
  postId    String   @map("post_id")
  userId    String   @map("user_id")
  
  // 元数据
  createdAt DateTime @default(now()) @map("created_at")
  
  post      Post     @relation(fields: [postId], references: [id], onDelete: Cascade)
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  @@map("likes")
  @@unique([postId, userId]) // 用户对每个帖子只能点赞一次
  @@index([postId])
  @@index([userId])
}

// 帖子类型枚举
enum PostType {
  SHARE_WIN       // 晒单分享
  EXPERIENCE      // 经验分享
  DISCUSSION      // 讨论
  ANNOUNCEMENT    // 公告
}

// 帖子状态枚举
enum PostStatus {
  DRAFT           // 草稿
  PUBLISHED       // 已发布
  HIDDEN          // 已隐藏
  DELETED         // 已删除
}

// 评论状态枚举
enum CommentStatus {
  PUBLISHED       // 已发布
  HIDDEN          // 已隐藏
  DELETED         // 已删除
}

// ==========================================
// 9. 系统配置和管理
// ==========================================

// 系统配置表
model SystemConfig {
  id          String   @id @default(cuid())
  key         String   @unique
  value       String
  description String?
  dataType    String   @default("string") @map("data_type") // string, number, boolean, json
  category    String   @default("general")
  
  // 元数据
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")
  
  @@map("system_configs")
  @@index([category])
}

// 操作日志表
model AuditLog {
  id          String   @id @default(cuid())
  userId      String?  @map("user_id")
  action      String   // 操作类型
  resource    String   // 资源类型
  resourceId  String?  @map("resource_id")
  
  // 操作详情
  oldData     Json?    @map("old_data")
  newData     Json?    @map("new_data")
  description String?
  
  // 请求信息
  ipAddress   String?  @map("ip_address")
  userAgent   String?  @map("user_agent")
  
  // 元数据
  createdAt   DateTime @default(now()) @map("created_at")
  
  @@map("audit_logs")
  @@index([userId])
  @@index([action])
  @@index([resource])
  @@index([createdAt])
}